# Codex向け共有ドキュメント
電柱・電線ネットワーク生成ツールの検討経緯と現時点の設計方針

## 1. この文書の目的
この文書は、実装時に設計意図がズレないようにするための共有資料です。  
機能一覧だけでなく、次を固定することを目的にします。

- 何を作るか
- 何を優先するか
- どこで迷い、どう判断したか
- 今決めること / 今は決めないこと

現時点は機能追加よりも、データ設計の芯を固める段階です。

## 2. 全体像
目的は、ゲームエンジン上で日本の電柱・電線のような「わちゃわちゃした」配線を自動生成し、必要なら局所手直しできる基盤を作ることです。  
初期は見た目と生成品質を優先し、将来は疎通判定や電気計算に拡張しやすい構造を維持します。

想定用途:

- 都市生成（道路や建物から配線生成）
- ゲーム用途（見た目重視、必要なら疎通判定）
- UE利用（高優先）
- OSS化の可能性

## 3. 優先順位（固定）
1. 見た目の自然さ（最優先）
2. 自動生成が主役（手で1本ずつ引かない）
3. テンプレート複数対応でも自然につながること
4. ランダム感（同じ結果になりすぎない）
5. 将来の疎通計算への拡張
6. 手直しは可能にする（ただし厳格ロックは後回し）

## 4. 非機能・実装方針
- 計算量は局所処理ベースで O(n) 寄り
- Dirty/Version で部分再計算
- 無関係データを巻き込まない
- レイキャスト選択（Pole/Span/パーツ）前提
- カリングは用途別・実行時調整可能
- CoreはネイティブC++でUE接続しやすい構造
- 座標系UE準拠、内部double
- 時間源は抽象化

## 5. 操作と生成の基本方針
- ツールの主導線は自動生成
- 手修正は補助導線（必要箇所のみ）
- DrawPath（入力ポリライン）導線を維持
  - 点列入力
  - プレビュー
  - Generate
  - 既存モード（配置/接続/分岐/詳細）と共存

## 6. 主要論点と判断経緯

### 6.1 複数本配線をどう扱うか
1本単位の積み上げでは高圧3本などで運用負荷とねじれが増えるため、群単位が必要という判断。

方針:

- `WireGroup` 導入（論理/生成/編集の単位）
- `WireLane` 導入（群内の識別可能な1本）
- `Span` は実体として残し、Group配下の構成要素として扱う

### 6.2 4本系での傾斜・クロス問題
検証結果では、方向Auto/Forward/Reverseは二次要因で、主因はカテゴリ有効スロット不足と高さ不一致。  
結論: 方向最適化単独では不十分。群単位管理を優先する。

### 6.3 slot と Port の混同
この区別は固定する。

- `slot` = テンプレート上の配置候補
- `Port` = 実在する接続点（実体）

### 6.4 Span端スタイル案の撤回
同一Portに複数Span接続があるため、Span側端スタイルは競合しやすい。  
結論: 接続点近傍の見た目（碍子・支持金具など）はPort側に寄せる。

### 6.5 Bundleの意味整理
`Bundle` の意味が混在しやすいため、当面は見た目/表現寄りに寄せる。  
論理/生成のまとまりは `WireGroup` 側へ。

## 7. 現時点のコア方針（重要）

### 7.1 正本として扱う単位
- `WireGroup`（導入予定）
- `WireLane`（導入予定）
- `Span`（Group配下の実区間）
- `Port`（実在接続点）
- `Pole`（支持物）

### 7.2 Portの扱い
- Portは実体として保持（仮想点ではない）
- 空中分岐もPort扱い可
- 現状は `owner_pole_id nullable` で運用可
- 将来必要なら `owner_kind + owner_id` に一般化

### 7.3 見た目と疎通の分離
- 内部識別は `WireLane` で個別管理可能にする
- 描画は束表示/個別表示の切替余地を残す

### 7.4 自動生成と手修正の境界
軽微変更で手修正が消えるのを避けるため、少なくとも Port/Pole に以下を持たせる方針。

- 生成由来（セッションID等）
- 手修正フラグ
- 再生成時の上書き可否判断材料

## 8. 将来拡張に向けた方針（今は実装しない）
- 付設物所有先の一般化（`owner_kind / owner_id`）
- 支持線とメイン線分離表現（まずPort側スタイルで吸収）
- Pole傾きはTransformで表現、手動/自動姿勢を混同しない

## 9. 性能観点の結論
- Group導入の1段ネストは主因ではない
- 主因は全件走査と全体再計算
- Group導入はむしろ局所再計算に有利

重要ポイント:

- Dirty粒度
- 近傍処理
- 描画キャッシュ粒度
- レイキャスト候補絞り込み
- 影含むカリング柔軟性

## 10. 直近で進めるべき段階
Phase4.9（PlacementZone）とPhase5（保存）は後回し。  
まず以下を先行:

1. ER図/データモデル更新（WireGroup/WireLane方向）
2. 設計棚卸し（型責務/層構造/依存方向）
3. その後に機能実装（Path方向、群レーン等）

## 11. Phase4.x（設計棚卸し）の位置づけ
新機能フェーズではなく、設計整理フェーズ。

実施内容:

- 現行型一覧化
- 責務1行定義
- 4層分類（定義/実体/作業情報/キャッシュ）
- 依存方向ルール固定
- 保存候補/再計算対象の仮分類
- 命名整理（slot/port/bundle）

## 12. ER図改善方針（実装前の方向）
追加したいもの（優先）:

- `WIRE_GROUP`
- `WIRE_LANE`
- `PORT` の由来/手修正情報
- `ATTACHMENT` の所有一般化

方針のみ固定:

- Bundleは見た目寄り補助へ
- 接続点近傍見た目はPort側へ
- 将来 `PortSocket` 導入余地を残す

## 13. Codexへの期待する進め方
この段階でやってほしいこと:

- 設計棚卸しPhase4.xを進める
- 型一覧と責務をドキュメント化
- WireGroup/WireLane導入方向をデータモデルへ反映
- 用語の意味を明示（slot/port/bundle）
- 既存挙動非破壊を最優先

この段階でやらなくてよいこと:

- PlacementZone本格導入
- 保存/読込確定
- 厳密電気計算
- 高品質サグ物理
- 大規模最適化の作り込み

## 14. 判断背景（運用上の理由）
AI実装では症状対処型になりやすいため、先に設計の芯を固定してズレを減らす。

- 見た目最優先
- 正本単位の明確化
- 責務配置（Port側スタイル、Spanは線本体）
- 手修正と自動生成の境界明確化

## 15. Codex向け短い指示文
- 今は新機能追加よりデータモデル整理を優先
- 見た目最優先、自動生成主役、UE前提
- Portは実在接続点として扱う（空中分岐もPort可）
- 複数本はWireGroup/WireLane導入方向で扱う
- Spanは残すがGroup配下構成要素として整理
- Bundleは論理正本でなく見た目寄り補助へ
- 接続点近傍見た目はPort側、Span端スタイルは採用しない
- Phase4.9/Phase5は後回しでよい
- まず型一覧、責務、4層分類、依存方向、命名整理を出す
- 既存挙動を壊さないことを優先

## 16. 追記: 直近確定ルール
- 鋭角対策は固定ルールで運用する（`corner interior angle < 75°`、カテゴリ例外なし、UI調整なし、不足時は自動拡幅）。目的は線間距離確保。

## 17. タスク進行ルール（運用固定）
- 要件が曖昧なまま実装しない。先に質問して合格基準を確定してから着手する。
- 修正は「症状」ではなく「目的」をテスト化してから行う。
- チャットで確定した仕様・運用ルールは、同ターンで `docs` に反映する。
- 反映先は最低 `docs/wire.md` と `docs/codex_shared_context.md` とする。

## 18. 新規チャット向け引き継ぎチェックリスト
新規チャット開始時に漏れやすい事項を先に固定する。

- 参照順序: `docs/wire.md` → `docs/codex_shared_context.md` → `core/tests/test_case_matrix.md`
- 鋭角対応は固定ルールで扱う（目的は線間距離確保、`corner interior angle < 75°`、カテゴリ例外なし、UI調整なし、不足時は自動拡幅）
- 実装方針: 既存挙動非破壊を優先、曖昧点は着手前質問
- テスト方針: 公開観測のみ、実装依存assert禁止、異常系を必ず含める
- 完了条件: 仕様更新をdocsへ反映し、`wire_core_tests` 全件パスを確認

補足: 本項目の詳細版は `docs/chat_handoff_checklist.md` に集約する。
