#要求仕様書
電柱・電線ネットワーク基盤(ネイティブ実装＋軽量viewer)

##1.目的
ゲームエンジン上で電柱・電線ネットワークを再現するための基盤を構築する。
見た目の再現だけでなく、接続関係の管理、探索、選択、保存読込、部分再計算、カリング、調整可能な性能制御を行えることを目的とする。

本基盤はまずネイティブC++で実装し、後からUE等のゲームエンジンへ接続する。

##2.スコープ
本仕様の対象は以下とする。

-コアライブラリ(core)
-開発用軽量viewer(viewer)
-保存読込(編集状態)
-選択(レイキャスト)
-カリング
-部分再計算
-将来拡張を見据えたデータ構造

本仕様の対象外(初期段階では実装しない可能性あり)

-高精度な物理シミュレーション
-厳密な電気計算
-UE専用アダプタの詳細実装
-最終品質の見た目メッシュ表現
-高度なオクルージョンカリング
-マルチスレッド本実装

##3.前提条件と固定方針

###3.1座標系
-座標系はUE準拠とする。
-内部計算精度はdoubleを使用する。
-描画連携時は必要に応じてfloatへ変換してよい。

###3.2ID
-全オブジェクトは64bit永続IDを持つ。
-IDは再利用しない。
-UUIDやハッシュ値は採用しない。
-人間が追いやすい表示用ID(例:SP-000123)を表示できること。

###3.3状態分離
-編集状態(永続化対象)と生成キャッシュ(再生成可能)を分離する。
-保存対象は編集状態のみとする。
-曲線サンプル、AABB、メッシュ、空間インデックス等はキャッシュとして扱い、保存しない。

###3.4編集方式
-内部データの直接更新は禁止する。
-すべての更新は編集API経由で行う。
-編集APIがDirty/Version更新の責務を持つ。

###3.5時間源
-時間源は抽象化する。
-時間依存機能は決定的にテスト可能な構造にする。

##4.設計思想

###4.1接続と支持の分離
電線は電柱そのものではなく接続点(Port)に接続する。
支持はAnchorで扱う。
これにより空中分岐や建物引込、2点支持碍子、支持線追従などを同一枠組みで扱える。

###4.2電線の表現
電線は物理剛体ではなく、制約付き曲線セグメントとして扱う。
形状はポート間の曲線として生成し、張力やサグや拘束を反映する。

###4.3描画と選択の分離
選択判定は描画メッシュに依存しない。
レイキャストは専用の判定データ(線分近似、カプセル、AABB等)を使用する。

###4.4カリングの用途分離
カリングは用途別に分離する。

-画面表示カリング
-影カリング
-更新カリング
-選択候補の絞り込み(必要に応じて)

##5.機能要件

##5.1コアデータモデル(編集状態)

###5.1.1Pole(支持構造)
-電柱、鉄塔、壁面支持等を表現できること。
-ワールド座標のTransformを持つこと。
-配下のPortおよびAnchorを保持できること。
-構造種別を持てること。

###5.1.2Port(接続点)
-電気的接続の最小単位として扱えること。
-位置および方向フレームを持つこと。
-電柱配下の接続点および空中分岐点を表現できること。
-種別(高圧/低圧/通信/光など)を持てること。

###5.1.3Anchor(支持点)
-支持専用点として扱えること。
-単碍子支持、2点支持の構成要素、中間支持、支持金具等を表現できること。
-Spanから参照できること。

###5.1.4Bundle(束)
-高圧3相等の複数導体を束として扱えること。
-導体本数、相間距離、配置ルール等を持てること。
-論理接続と描画展開を分離できること。
-現時点ではBundleは見た目/表現寄りの補助情報として扱い、論理・生成の正本は将来導入するWireGroup/WireLane側へ寄せられる構造であること。

###5.1.5Span(スパン)
-Port間を結ぶ論理区間として表現できること。
-電線種別、張力、サグ係数、最小曲率半径等を持てること。
-支持点(Anchor)を複数参照できること。
-拘束情報(支持線追従等)を持てること。
-部分再計算管理の中心単位として扱えること。

###5.1.6Attachment(付属物)
-Span上の位置t(0..1)で配置できること。
-ダンパ、スペーサ、クロージャ、開閉器等を表現できること。
-将来拡張可能な属性を持てること。

###5.1.7WireGroup/WireLane(導入方針)
-複数本配線を群として扱うため、WireGroup(論理/生成単位)とWireLane(群内識別単位)を導入可能な構造であること。
-Spanは実区間として残し、Group配下の構成要素として整理できること。
-現段階では実装必須ではないが、データモデル上の拡張方向として固定すること。

##5.2接続・探索機能

###5.2.1接続管理
-種別ごとに接続関係を管理できること。
-ループを含む一般グラフを扱えること。
-接続インデックス(Port→Span等)を構築できること。

###5.2.2接続判定
-「繋がっているか」を高速に判定できる構造を持つこと。
-削除を含む編集を考慮し、局所的に再構築可能であること。

###5.2.3経路探索
-経路探索(BFS/Dijkstra/A*)が可能であること。
-種別ごとの探索が可能であること。
-論理接続と描画形状を分離して扱えること。

##5.3形状生成機能

###5.3.1基本形状
-Spanの曲線を生成できること。
-サグを表現できること。
-張力や種別に応じた形状調整が可能であること。

###5.3.2分岐表現
-空中分岐を表現できること。
-分岐時に角ではなく曲率を持つ形状を生成できること。
-本線と引込線の張力差や剛性差を表現できること。

###5.3.3支持構造反映
-単碍子支持を表現できること。
-2点支持碍子を表現できること。
-中間支持を表現できること。
-支持線に沿う架線(メッセンジャ付き)を表現できること。

###5.3.4束の描画展開
-束を複数導体に展開できること。
-局所フレームを用いて導体配置を制御できること。
-不自然なクロスを起こしにくい構造であること。

###5.3.5鋭角時のPole向き補正
-鋭角コーナー時はPole向きを中線直交方向へ補正できること。
-現時点の固定条件は `turn angle < 40°` とすること。
-この閾値は定数として扱い、UIからの実行時調整対象にはしないこと。

##5.4選択(レイキャスト)機能

###5.4.1選択対象
-柱/支持構造を選択できること。
-電線(Span)を選択できること。
-付属物(Attachment)を選択できること。

###5.4.2判定方式
-描画メッシュを使わず専用判定を用いること。
-柱はカプセル等で近似できること。
-線はポリライン+半径で判定できること。
-付属物は球/OBB等で判定できること。

###5.4.3選択結果
-ヒット対象種別を取得できること。
-対象IDを取得できること。
-ヒット位置を取得できること。

###5.4.4選択の安定性
-LOD変更時も選択対象IDが安定すること(描画LOD非依存)。

##5.5カリング機能

###5.5.1種類
-画面表示カリングを実装できること。
-影カリングを画面表示カリングと独立して制御できること。
-更新カリングを実装できること。
-距離カリングを設定できること。

###5.5.2柔軟性
-カリング閾値を実行時に変更できること。
-カリングON/OFFを実行時に切替できること。
-環境差に合わせて調整可能であること。

###5.5.3Span向け対策
-Spanを分割AABBで扱えること。
-単一AABBのみの設計にしないこと。

##5.6部分再計算機能

###5.6.1基本方針
-必要な箇所だけ再計算すること。
-全体再計算を標準動作にしないこと。

###5.6.2Dirty管理
-Dirty管理を採用すること。
-Dirty粒度は基本Span単位とすること。
-Dirty種別を持てること(Topology/Geometry/Bounds/Render/Raycast等)。

###5.6.3Version管理
-DirtyだけでなくVersionを持つこと。
-編集状態Versionと各キャッシュVersionを分離すること。
-Dirty漏れ検出や整合性確認が可能であること。

###5.6.4DirtyQueue
-Dirty対象をキューで管理できること。
-全件スキャンを避けられること。
-初期段階では重複投入を許容してよい。

###5.6.5伝播
-Dirty伝播方向は一方向とすること。
-双方向依存を持たないこと。

##5.7永続化機能

###5.7.1保証事項
-保存→読込後に編集状態が一致すること。
-同一編集状態から同一キャッシュ結果を再生成できること。

###5.7.2保存対象
保存対象
-Pole
-Port
-Anchor
-Bundle
-Span
-Attachment
-ID
-各種編集パラメータ
-必要な設定値

非保存対象
-CurveCache
-BoundsCache
-RaycastCache
-RenderCache
-空間インデックス
-一時的なランタイム計測値

###5.7.3決定性
-乱数を使う場合はseedを管理できること。
-時間依存処理は時間源固定で再現できること。

###5.7.4ファイル形式
-初期はJSONを許容する。
-フォーマットバージョンを持つこと。
-将来バイナリ形式に移行可能な構造であること。

##5.8性能調整機能

###5.8.1調整可能性
以下を実行時に調整できること。

-カリングON/OFF
-距離閾値
-LOD閾値
-曲線分割数
-影ON/OFF
-レイキャスト精度
-更新スキップ条件

###5.8.2計測可能性
最低限以下を観測できること。

-フレーム時間
-再計算対象数
-カリング前後の件数
-レイキャスト時間
-Dirty件数

###5.8.3データ構造方針
-SoAは爆発する層(曲線サンプル、頂点等)に限定する。
-電柱やPort等はAoS寄りを許容する。
-可変長データはCSR等の形式を使えること。

##5.9viewer機能(開発用軽量ビューワ)

###5.9.1目的
-コアの状態を人間が視認しながら検証できること。
-編集、選択、部分再計算、カリング、保存読込の確認を行えること。
-ゲームエンジン接続前の検証環境として常用できること。

###5.9.2前提
-ネイティブC++で動作すること。
-coreとは分離すること。
-viewerはcoreを呼び出す構造とすること。
-ゲームエンジン非依存とすること。

###5.9.3表示要件(最低限)
-Poleを表示できること。
-Portを表示できること。
-Anchorを表示できること。
-Spanを表示できること(初期は線で可)。
-Attachmentを表示できること(簡易表示で可)。

###5.9.4操作要件
-3Dカメラ操作(移動/回転/ズーム)ができること。
-選択機能を持つこと(初期は簡易でも可)。
-選択中オブジェクト情報(ID/種別/座標等)を表示できること。

###5.9.5編集要件(段階的)
初期
-電柱追加
-Port追加
-Span追加
-電柱移動
-削除

段階拡張
-Span分割(空中分岐)
-Anchor追加
-Attachment追加
-Bundle設定変更

###5.9.6部分再計算可視化
-Dirty対象Spanを色分け表示できること。
-再計算されたSpanを確認できること。
-Version情報を表示できること。
-DirtyQueue件数を表示できること。

###5.9.7選択確認
-柱/線/付属物の選択結果を表示できること。
-ヒット位置を表示できること。
-LOD変更時の選択安定性を確認できること。

###5.9.8カリング確認
-画面カリングON/OFF
-影カリングON/OFF
-更新カリングON/OFF
-距離閾値変更
-カリング件数表示
を行えること。

###5.9.9デバッグ表示
以下を切替表示できることが望ましい。

-座標軸
-グリッド
-Port/Anchorフレーム
-Span AABB
-当たり判定形状
-Validation結果

###5.9.10計測表示
-フレーム時間
-再計算Span数
-表示中Span数
-レイキャスト時間
-カリング前後件数
を表示できること。

###5.9.11非機能要件
-軽量で常時起動しやすいこと。
-コアの不正状態を発見しやすいこと。
-調整値変更が即時反映されること。
-見た目の完成度は初期段階では優先しないこと。

##6.非機能要件

###6.1拡張性
以下に構造変更なしまたは最小変更で対応できること。

-風揺れ
-簡易電気計算
-UEアダプタ追加
-高品質形状生成
-空間インデックス差し替え
-Undo/Redo
-差分保存

###6.2保守性
-検証(Validation)機構を持てること。
-ログや計測で問題箇所を追跡しやすいこと。
-編集API経由の更新で副作用を集中管理できること。

###6.3性能
-基本操作は線形スケールを目標とする。
-N²系の全探索を標準動作にしない。
-近傍判定や候補絞り込みは空間インデックスで改善可能な構造とする。

###6.4マルチスレッド拡張性
-編集状態更新はメインスレッドに限定する。
-キャッシュ生成は将来並列化可能な構造とする。
-同期点で反映する構造にできること。

##7.テスト要求(テスト憲法要約)

###7.1テスト対象の考え方
-テストは不変条件を守る。
-見た目の細部や内部最適化方式は固定しない。

###7.2中核不変条件
-接続関係が壊れない。
-部分再計算で整合が保たれる。
-保存→読込後に編集状態が一致する。
-同一編集状態から同一キャッシュを再生成できる。
-選択結果がLODに依存しない。
-種別ごとの探索が混線しない。

###7.3性能テスト方針
-ミリ秒固定の合否判定は原則行わない。
-局所更新になっているかを観測する。
-回帰検知として計測値は取る。

###7.4モック方針
-モックは外部境界のみ。
-接続更新、Dirty伝播、Version整合、幾何生成、選択判定はモックしない。

##8.段階実装要求
本件は段階実装可能であることを要求する。
各段階でviewerにより人間が視認・確認できる状態を維持すること。

###Phase0
-viewer骨組み(起動、カメラ、座標軸、グリッド)

###Phase1
-core土台(ID、ObjectStore、CoreState最小)
-viewerでcore状態の最小描画

###Phase2
-編集状態モデル(Pole/Port/Anchor/Bundle/Span/Attachment)
-Add系編集API
-viewerから最小編集

###Phase3
-Dirty/Version/DirtyQueue
-Move/Delete/Split基礎
-viewerでDirty可視化

###Phase4
-最小幾何生成(Curve/Bounds仮実装)
-viewerで線表示強化

###Phase4.x
-設計棚卸し(型一覧、責務、4層分類、依存方向、命名整理)
-新機能追加より設計の芯を固定
-保存読込(Phase5)前にPersist/Derived/SessionDebug分類を明確化

###Phase5
-保存読込(編集状態のみ)
-viewerで保存読込確認

###Phase6
-レイキャスト基礎
-viewerで選択確認

###Phase7
-カリング/LOD調整基礎
-viewerで調整UIと観測

###Phase8以降
-表現強化(分岐曲率、支持線追従、束の高品質化等)
-将来拡張(風揺れ、簡易電気計算、並列化、UE接続)

##9.実装依頼時の運用要求(Codex向け)
-一度に全機能を実装させないこと。
-各Phaseごとに固定事項、今回の実装範囲、非スコープ、受け入れ条件を明示すること。
-将来拡張用の抽象化を先に過剰実装しないこと。
-必ずテストコードを含めること。
-Viewerで確認可能な状態を維持すること。
-Phase4.xでは新機能追加よりデータモデル整理を優先すること。
-既存挙動を壊さないことを最優先にすること。
-大規模リファクタは行わず、棚卸しと責務整理を先に成果物化すること。

##10.受け入れ基準(総合)
以下を満たした場合に本基盤は要求を満たすとする。

-コアが編集状態を保持・更新できる
-部分再計算がSpan単位で機能する
-保存読込で編集状態が一致する
-同一状態から決定的に再生成できる
-Viewerで人間が編集・選択・確認できる
-カリングやLODを調整しながら挙動を観測できる
-将来のゲームエンジン接続に依存しない構造になっている

##11.現時点の補足方針(更新)
この仕様の補足として、検討経緯込みの共有文書 `codex_shared_context.md` を併用する。
設計棚卸しの現行成果物は `docs/core_model_inventory.md` とする。

-見た目最優先、自動生成主役という優先順位を維持する。
-slot(テンプレート候補)とPort(実体接続点)を厳密に区別する。
-接続点近傍の見た目(碍子等)はPort側へ寄せ、Span端スタイルには寄せない。
-Phase4.9(PlacementZone)とPhase5(保存)は、Phase4.xの設計棚卸し完了後に進める。
